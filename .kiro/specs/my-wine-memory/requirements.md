# MyWineMemory 要件定義書

## はじめに

MyWineMemoryは、ワイン愛好家が飲んだワインを記録し、クイズを通じてワイン知識を学習できるWebアプリケーションです。バーのような落ち着いた大人の雰囲気を持つダークテーマのデザインで、ワインテイスティングの記録から学習まで一貫したワイン体験を提供します。

## 要件

### 要件1：ユーザー認証システム

**ユーザーストーリー：** ワイン愛好家として、自分のワイン記録を安全に管理し、どのデバイスからでもアクセスできるようにしたい

#### 受け入れ基準

1. WHEN ユーザーがアプリにアクセスした時 THEN システムはGoogle認証によるログインオプションを提供する
2. WHEN ユーザーがゲストとしてアプリを使用した時 THEN システムはローカルストレージにデータを一時保存する
3. WHEN ゲストユーザーがログインした時 THEN システムはゲストデータを自動的にユーザーアカウントに移行する
4. WHEN ユーザーがログアウトした時 THEN システムは認証状態をクリアし、ゲストモードに戻る

### 要件2：ワインテイスティング記録システム

**ユーザーストーリー：** ワイン愛好家として、飲んだワインの詳細情報とテイスティングノートを記録し、後で振り返ることができるようにしたい

#### 受け入れ基準

1. WHEN ユーザーが新しいワイン記録を作成する時 THEN システムはワイン基本情報（名前、生産者、国、地域、ヴィンテージ）の入力を求める
2. WHEN ユーザーがクイックモードを選択した時 THEN システムは評価とメモのみの簡単な記録フォームを表示する
3. WHEN ユーザーが詳細モードを選択した時 THEN システムは外観、香り、味わい、構造の詳細分析フォームを表示する
4. WHEN ユーザーが画像をアップロードする時 THEN システムは最大5枚まで（無料プランは1枚）の画像を保存する
5. WHEN ユーザーがワイン記録を保存する時 THEN システムは記録をFirestoreに保存し、XPを付与する

### 要件3：ワイン記録管理・検索システム

**ユーザーストーリー：** ワイン愛好家として、過去に記録したワインを効率的に検索・閲覧し、お気に入りのワインを再発見したい

#### 受け入れ基準

1. WHEN ユーザーが記録一覧を表示する時 THEN システムはワイン別にグループ化された記録リストを表示する
2. WHEN ユーザーが検索機能を使用する時 THEN システムはワイン名、生産者、国、地域での絞り込み検索を提供する
3. WHEN ユーザーが高度フィルターを使用する時 THEN システムは価格帯、評価、ヴィンテージ、ワインタイプでの複合検索を提供する
4. WHEN ユーザーが個別ワイン詳細を表示する時 THEN システムは時系列のテイスティング履歴とチャート分析を表示する
5. WHEN ユーザーが自分の記録を編集する時 THEN システムは記録作成者のみに編集権限を付与する
6. WHEN ユーザーが自分の記録を削除する時 THEN システムは記録作成者のみに削除権限を付与し、削除時に獲得していたXPを減算する

### 要件4：ワインクイズ学習システム

**ユーザーストーリー：** ワイン学習者として、段階的なクイズを通じてワイン知識を体系的に学習し、進捗を確認したい

#### 受け入れ基準

1. WHEN ユーザーがクイズを開始する時 THEN システムは20レベル（初心者〜エキスパート）の難易度選択を提供する
2. WHEN ユーザーがクイズに回答する時 THEN システムは4択選択式の問題と解説を表示する
3. WHEN ユーザーが間違いを犯した時 THEN システムはハート（ライフ）を1つ減らし、0になったら30分の回復時間を設ける
4. WHEN ユーザーがレベルを完了する時 THEN システムは正解率と獲得XPを表示し、次のレベルをアンロックする
5. WHEN ユーザーが連続正解を達成する時 THEN システストリークボーナスXPを付与する

### 要件5：ゲーミフィケーション・進捗管理システム

**ユーザーストーリー：** ワイン愛好家として、記録やクイズの活動を通じて成長を実感し、継続的にアプリを使用するモチベーションを得たい

#### 受け入れ基準

1. WHEN ユーザーが活動を行う時 THEN システムは行動に応じたXP（記録作成：10-20XP、クイズ正解：5XP）を付与する
2. WHEN ユーザーのXPが一定値に達した時 THEN システムは自動的にレベルアップを実行し、通知を表示する
3. WHEN ユーザーが特定の条件を満たした時 THEN システムは67種類のバッジ（記録数、ストリーク、多様性）を授与する
4. WHEN ユーザーが日常目標を設定する時 THEN システムは記録作成とクイズの目標を管理し、達成時にボーナスXPを付与する
5. WHEN ユーザーが統計を確認する時 THEN システムは月別記録数、国別分布、品種分布のグラフを表示する

### 要件6：PWA・オフライン対応システム

**ユーザーストーリー：** モバイルユーザーとして、ネイティブアプリのような体験でワイン記録を行い、オフライン時でも基本機能を使用したい

#### 受け入れ基準

1. WHEN ユーザーがモバイルブラウザでアクセスする時 THEN システムはPWAインストールプロンプトを表示する
2. WHEN ユーザーがオフライン状態の時 THEN システムは記録の閲覧とクイズの実行を可能にする
3. WHEN ユーザーがオンラインに復帰した時 THEN システムはオフライン中の変更を自動同期する
4. WHEN 新しいバージョンが利用可能な時 THEN システムは更新通知を表示し、ユーザーの選択で更新を実行する

### 要件7：プッシュ通知システム

**ユーザーストーリー：** ワイン愛好家として、記録の習慣化とクイズ学習の継続のために、適切なタイミングでリマインダーを受け取りたい

#### 受け入れ基準

1. WHEN ユーザーが通知を許可した時 THEN システムは記録リマインダー、クイズリマインダー、バッジ獲得通知を送信する
2. WHEN ユーザーが静寂時間を設定した時 THEN システムは指定時間帯（例：22:00-08:00）の通知を停止する
3. WHEN ユーザーがストリークを継続している時 THEN システムは継続を促すパーソナライズされた通知を送信する
4. WHEN ユーザーがハートが回復した時 THEN システムはクイズ再開の通知を送信する

### 要件8：サブスクリプション・有料機能システム

**ユーザーストーリー：** ヘビーユーザーとして、より多くの画像アップロードと高度な機能を利用するために有料プランに加入したい

#### 受け入れ基準

1. WHEN 無料ユーザーが制限に達した時 THEN システムは有料プラン（500円/月）への案内を表示する
2. WHEN ユーザーが有料プランに加入する時 THEN システムはStripe決済を通じて安全な支払い処理を実行する
3. WHEN 有料ユーザーがワイン記録を作成する時 THEN システムは画像4枚まで、無制限記録、詳細統計を提供する
4. WHEN ユーザーがサブスクリプションを管理する時 THEN システムはStripe顧客ポータルへのアクセスを提供する

### 要件9：データエクスポート・バックアップシステム

**ユーザーストーリー：** データを重視するユーザーとして、自分のワイン記録を外部形式でエクスポートし、データの可搬性を確保したい

#### 受け入れ基準

1. WHEN 有料ユーザーがエクスポートを要求する時 THEN システムはCSV形式でワイン記録をダウンロード提供する
2. WHEN ユーザーがJSONエクスポートを選択する時 THEN システムは完全なデータ構造を含むJSONファイルを生成する
3. WHEN エクスポート処理が完了した時 THEN システムはダウンロードリンクをメールまたは画面で提供する
4. WHEN ユーザーがデータ削除を要求した時 THEN システムはGDPR準拠の完全なデータ削除を実行する

### 要件10：過去記録引用システム

**ユーザーストーリー：** 効率的なワイン記録者として、過去に記録した類似ワインの情報を参照・引用して、新しい記録作成時間を短縮したい

#### 受け入れ基準

1. WHEN ユーザーが新規記録を作成する時 THEN システムは過去の類似ワイン記録（同じ生産者・品種）を候補として表示する
2. WHEN ユーザーが過去記録を引用する時 THEN システムは選択したフィールド（香り、味わい、環境情報など）を新規記録にコピーする
3. WHEN ユーザーが引用データを編集する時 THEN システムは引用元との差分を明確に表示する
4. WHEN 引用が完了した時 THEN システムは引用履歴を記録し、引用元記録に被引用回数を追加する

### 要件11：エラーハンドリング・オフライン対応

**ユーザーストーリー：** 安定したサービスを求めるユーザーとして、ネットワークエラーやシステム障害時でも適切な案内と復旧機能を得たい

#### 受け入れ基準

1. WHEN ネットワークエラーが発生した時 THEN システムは自動リトライ機能と分かりやすいエラーメッセージを表示する
2. WHEN Firebaseサービスが一時的に利用できない時 THEN システムはローカルストレージにデータを保存し、復旧時に同期する
3. WHEN ユーザーが無効な操作を行った時 THEN システムは具体的な修正方法を含むバリデーションメッセージを表示する
4. WHEN 予期しないエラーが発生した時 THEN システムはSentryにエラーログを送信し、ユーザーには復旧手順を案内する

### 要件12：セキュリティ・プライバシー保護

**ユーザーストーリー：** プライバシーを重視するユーザーとして、個人のワイン記録が適切に保護され、必要に応じて公開範囲を制御したい

#### 受け入れ基準

1. WHEN ユーザーがワイン記録を作成する時 THEN システムは公開・非公開の設定オプションを提供する
2. WHEN ユーザーが価格情報を入力する時 THEN システムは非公開設定時にこの情報を他ユーザーから隠す
3. WHEN 不正なアクセスが検知された時 THEN システムはFirestore Security Rulesにより所有者以外のアクセスを拒否する
4. WHEN ユーザーがアカウント削除を要求した時 THEN システムはGDPR準拠で全ての個人データを完全削除する

### 要件13：パフォーマンス・最適化

**ユーザーストーリー：** 快適な操作を求めるユーザーとして、高速なページ読み込みとスムーズな操作レスポンスを体験したい

#### 受け入れ基準

1. WHEN ユーザーがアプリにアクセスする時 THEN システムは初期ロードを3秒以内に完了する
2. WHEN ユーザーが画像をアップロードする時 THEN システムはWebP形式への自動変換と圧縮を実行する
3. WHEN ユーザーがページ間を移動する時 THEN システムはReact.lazyによる遅延読み込みで高速な遷移を提供する
4. WHEN 大量のデータを表示する時 THEN システムは仮想スクロールやページネーションで快適な操作性を維持する

### 要件14：ワインマスターデータ管理

**ユーザーストーリー：** 正確なワイン情報を求めるユーザーとして、重複のない統一されたワインデータベースから情報を選択・入力したい

#### 受け入れ基準

1. WHEN ユーザーがワイン名を入力する時 THEN システムは既存のワインマスターデータから候補を提案する
2. WHEN 同じワインの重複登録が検出された時 THEN システムは既存ワインとの統合を提案する
3. WHEN ユーザーが新しいワインを登録する時 THEN システムはワインマスターデータに新規エントリを作成する
4. WHEN ワイン情報に不整合がある時 THEN システムは管理者による承認プロセスを経て修正する

### 要件15：統計・分析ダッシュボード

**ユーザーストーリー：** データ分析を好むユーザーとして、自分のワイン消費パターンや味覚の傾向を視覚的に理解したい

#### 受け入れ基準

1. WHEN ユーザーが統計ページを表示する時 THEN システムは月別記録数、国別分布、品種別分布をグラフで表示する
2. WHEN ユーザーが味覚分析を確認する時 THEN システムは酸味・タンニン・甘味・ボディの平均値をレーダーチャートで表示する
3. WHEN ユーザーが価格分析を確認する時 THEN システムは価格帯別の記録数と平均評価を棒グラフで表示する
4. WHEN ユーザーが年間サマリーを確認する時 THEN システムは総記録数、お気に入りワイン、成長指標を一覧表示する

### 要件16：LLM連携・AI機能

**ユーザーストーリー：** ワイン学習者として、自分の記録データに基づいたパーソナライズされたクイズや分析を受けて、より効果的に学習したい

#### 受け入れ基準

1. WHEN ユーザーがAIクイズを要求する時 THEN システムはOpenRouter/Groq APIを使用してユーザーの記録に基づいた問題を生成する
2. WHEN ユーザーが味覚分析を要求する時 THEN システムはLLMを使用してユーザーの味覚傾向を分析・レポート生成する
3. WHEN 有料ユーザーがAI機能を使用する時 THEN システムは無制限のLLM API呼び出しを提供する
4. WHEN 無料ユーザーがAI機能を使用する時 THEN システムは月10回までの制限を適用する

### 要件17：手描きキャンバス・視覚的記録

**ユーザーストーリー：** 視覚的な記録を好むユーザーとして、テイスティングノートに手描きの図表やスケッチを追加したい

#### 受け入れ基準

1. WHEN ユーザーが詳細記録モードを選択する時 THEN システムは手描きキャンバス機能を提供する
2. WHEN ユーザーがキャンバスに描画する時 THEN システムはペン・消しゴムツール、ブラシサイズ（1-20px）、カラーピッカーを提供する
3. WHEN ユーザーがマウス・タッチで描画する時 THEN システムは統一されたインタラクション処理を実行する
4. WHEN ユーザーが描画を保存する時 THEN システムはPNG形式のData URLとして画像を生成・保存する

### 要件18：グラスタイプ選択・環境記録

**ユーザーストーリー：** 本格的なテイスティングを行うユーザーとして、使用したグラスタイプや環境情報を詳細に記録したい

#### 受け入れ基準

1. WHEN ユーザーが環境情報を入力する時 THEN システムはワインタイプに適したグラス選択肢（8種類）を画像付きで表示する
2. WHEN ユーザーがグラスを選択する時 THEN システムは容量、特徴、製造メーカー情報を表示する
3. WHEN ユーザーが環境情報を記録する時 THEN システムは温度、デカンタ使用、照明、気分、同伴者、機会を記録する
4. WHEN ユーザーが環境データを分析する時 THEN システムは環境条件と評価の相関関係を統計表示する

### 要件19：時系列テイスティング・変化記録

**ユーザーストーリー：** 詳細なテイスティングを行うユーザーとして、同一ワインの時間経過や温度変化による味わいの変化を記録したい

#### 受け入れ基準

1. WHEN ユーザーが時系列ノートを追加する時 THEN システムは時刻、温度、味わいの変化を記録するフォームを提供する
2. WHEN ユーザーが複数の時点でノートを追加する時 THEN システムは時系列順に整理された変化記録を表示する
3. WHEN ユーザーが時系列データを確認する時 THEN システムは味わいの変化を線グラフで視覚化する
4. WHEN ユーザーが類似ワインを比較する時 THEN システムは時系列変化パターンの類似性を分析・表示する

### 要件20：レスポンシブデザイン・アクセシビリティ

**ユーザーストーリー：** 様々なデバイスを使用するユーザーとして、スマートフォンからデスクトップまで一貫した使いやすい体験を得たい

#### 受け入れ基準

1. WHEN ユーザーが異なる画面サイズでアクセスする時 THEN システムは320px〜1920pxの範囲で適切にレイアウトを調整する
2. WHEN ユーザーがキーボードナビゲーションを使用する時 THEN システムは全ての機能にキーボードでアクセス可能にする
3. WHEN スクリーンリーダーユーザーがアクセスする時 THEN システムは適切なARIA属性とセマンティックHTMLを提供する
4. WHEN ユーザーがダークテーマを使用する時 THEN システムはバーのような落ち着いた大人の雰囲気のデザインを表示する